"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},RowManager=function(t){this.table=t,this.element=$("<div class='tabulator-tableHolder' tabindex='0'></div>"),this.tableElement=$("<div class='tabulator-table'></div>"),this.columnManager=null,this.height=0,this.firstRender=!1,this.renderMode="classic",this.rows=[],this.activeRows=[],this.activeRowsCount=0,this.displayRows=[],this.displayRowsCount=0,this.scrollTop=0,this.scrollLeft=0,this.vDomRowHeight=20,this.vDomTop=0,this.vDomBottom=0,this.vDomScrollPosTop=0,this.vDomScrollPosBottom=0,this.vDomTopPad=0,this.vDomBottomPad=0,this.vDomMaxRenderChain=90,this.vDomWindowBuffer=0,this.vDomWindowMinTotalRows=20,this.vDomWindowMinMarginRows=5,this.vDomTopNewRows=[],this.vDomBottomNewRows=[],this._initialize()};RowManager.prototype.getElement=function(){return this.element},RowManager.prototype.getTableElement=function(){return this.tableElement},RowManager.prototype.setColumnManager=function(t){this.columnManager=t},RowManager.prototype._initialize=function(){var t=this;t.element.append(t.tableElement),t.firstRender=!0,t.element.scroll(function(){var o=t.element[0].scrollLeft;t.scrollLeft!=o&&(t.columnManager.scrollHorizontal(o),t.table.options.groupBy&&t.table.extensions.groupRows.scrollHeaders(o),t.table.extExists("columnCalcs")&&t.table.extensions.columnCalcs.scrollHorizontal(o)),t.scrollLeft=o}),t.table.options.height&&t.table.options.virtualDom&&t.element.scroll(function(){var o=t.element[0].scrollTop,e=t.scrollTop>o;t.scrollTop!=o?(t.scrollTop=o,t.scrollVertical(e)):t.scrollTop=o})},RowManager.prototype.findRow=function(t){var o=this;return"object"==(void 0===t?"undefined":_typeof(t))?t instanceof Row?t:t instanceof jQuery?o.rows.find(function(o){return o.element===t})||!1:t._getSelf()||!1:o.rows.find(function(e){return e.data[o.table.options.index]==t})||!1},RowManager.prototype.scrollToRow=function(t){var o;if((o=this.displayRows.indexOf(t))>-1)switch(this.renderMode){case"classic":this.element.scrollTop(t.element.offset().top-this.element.offset().top+this.element.scrollTop());break;case"virtual":this._virtualRenderFill(o,!0)}},RowManager.prototype.setData=function(t){var o=this;o.table.options.dataLoading(t),o.rows=[],this.table.options.history&&this.table.extExists("history")&&this.table.extensions.history.clear(),Array.isArray(t)&&(this.table.extExists("selectRow")&&this.table.extensions.selectRow.clearSelectionData(),t.forEach(function(t,e){var i=new Row(t,o);o.rows.push(i)}),o.table.options.dataLoaded(t),o.refreshActiveData(!0))},RowManager.prototype.deleteRow=function(t){var o=this.rows.indexOf(t),e=this.activeRows.indexOf(t),i=this.displayRows.indexOf(t);i>-1&&this.displayRows.splice(i,1),e>-1&&this.activeRows.splice(e,1),o>-1&&this.rows.splice(o,1),this.setActiveRows(this.activeRows),this.setDisplayRows(this.displayRows),this.table.options.rowDeleted(t.getComponent()),this.table.options.dataEdited(this.getData()),this.table.options.pagination&&this.table.extExists("page")?this.refreshActiveData():this.renderTable()},RowManager.prototype.addRow=function(t,o,e){var i=this.addRowActual(t,o,e);return this.table.options.history&&this.table.extExists("history")&&this.table.extensions.history.action("rowAdd",i,{data:t,pos:o,index:e}),i},RowManager.prototype.addRowActual=function(t,o,e){var i=t||{},s=new Row(i,this),a=void 0===o?this.table.options.addRowPos:o;if(e&&(e=this.findRow(e)),"top"===a&&(a=!0),"bottom"===a&&(a=!1),e){var n=this.rows.indexOf(e),l=this.activeRows.indexOf(e),r=this.displayRows.indexOf(e);r>-1&&this.displayRows.splice(a?r:r+1,0,s),l>-1&&this.activeRows.splice(a?l:l+1,0,s),n>-1&&this.rows.splice(a?n:n+1,0,s)}else a?(this.displayRows.unshift(s),this.activeRows.unshift(s),this.rows.unshift(s)):(this.displayRows.push(s),this.activeRows.push(s),this.rows.push(s));return this.setDisplayRows(this.displayRows),this.setActiveRows(this.activeRows),this.table.options.rowAdded(s.getComponent()),this.table.options.dataEdited(this.getData()),this.renderTable(),s},RowManager.prototype.moveRow=function(t,o,e){this._moveRowInArray(this.rows,t,o,e),this._moveRowInArray(this.activeRows,t,o,e),this._moveRowInArray(this.displayRows,t,o,e),this.table.options.rowMoved(t.getComponent())},RowManager.prototype._moveRowInArray=function(t,o,e,i){var s,a,n,l=t.indexOf(o);if(l>-1&&(t.splice(l,1),(s=t.indexOf(e))>-1?i?t.splice(s+1,0,o):t.splice(s,0,o):t.splice(l,0,o)),t===this.displayRows){a=l<s?l:s,n=s>l?s:l+1;for(var r=a;r<=n;r++)t[r]&&this.styleRow(t[r],r)}},RowManager.prototype.clearData=function(){this.setData([])},RowManager.prototype.getRowIndex=function(t){return this.findRowIndex(t,this.rows)},RowManager.prototype.getDisplayRowIndex=function(t){return this.findRowIndex(t,this.displayRows)},RowManager.prototype.nextDisplayRow=function(t){var o=this.getDisplayRowIndex(t),e=!1;return!1!==o&&o<this.displayRowsCount-1&&(e=this.displayRows[o+1]),e},RowManager.prototype.prevDisplayRow=function(t){var o=this.getDisplayRowIndex(t),e=!1;return o&&(e=this.displayRows[o-1]),e},RowManager.prototype.findRowIndex=function(t,o){var e;return!!((t=this.findRow(t))&&(e=o.indexOf(t))>-1)&&e},RowManager.prototype.getData=function(t){var o=this,e=[];return(t?o.activeRows:o.rows).forEach(function(t){e.push(t.getData(!0))}),e},RowManager.prototype.getComponents=function(t){var o=this,e=[];return(t?o.activeRows:o.rows).forEach(function(t){e.push(t.getComponent())}),e},RowManager.prototype.getDataCount=function(t){return t?this.rows.length:this.activeRows.length},RowManager.prototype._genRemoteRequest=function(){var t=this,o=t.table,e=o.options,i={};if(o.extExists("page")){if(e.ajaxSorting){var s=t.table.extensions.sort.getSort();s[0]&&"function"!=typeof s[0].column&&(i[t.table.extensions.page.paginationDataSentNames.sort]=s[0].column.getField(),i[t.table.extensions.page.paginationDataSentNames.sort_dir]=s[0].dir)}if(e.ajaxFiltering){var a=t.table.extensions.filter.getFilter();a[0]&&"string"==typeof a[0].field&&(i[t.table.extensions.page.paginationDataSentNames.filter]=a[0].field,i[t.table.extensions.page.paginationDataSentNames.filter_type]=a[0].type,i[t.table.extensions.page.paginationDataSentNames.filter_value]=a[0].value)}t.table.extensions.ajax.setParams(i,!0)}o.extensions.ajax.sendRequest(function(o){t.setData(o)})},RowManager.prototype.filterRefresh=function(){var t=this.table,o=t.options;o.ajaxFiltering?"remote"==o.pagination&&t.extExists("page")?(t.extensions.page.reset(!0),t.extensions.page.setPage(1)):this._genRemoteRequest():this.refreshActiveData()},RowManager.prototype.sorterRefresh=function(){var t=this.table,o=this.table.options,e=this.scrollLeft;o.ajaxSorting?"remote"==o.pagination&&t.extExists("page")?(t.extensions.page.reset(!0),t.extensions.page.setPage(1)):this._genRemoteRequest():this.refreshActiveData(),this.element.scrollLeft(e)},RowManager.prototype.refreshActiveData=function(t){var o=this,e=this.table;e.options.selectable&&!e.options.selectablePersistence&&e.extExists("selectRow")&&e.extensions.selectRow.deselectRows(),e.extExists("filter")?(e.extensions.filter.hasChanged()||t)&&(o.setActiveRows(e.extensions.filter.filter(o.rows)),t=!0):o.setActiveRows(o.rows.slice(0)),e.extExists("sort")&&(e.extensions.sort.hasChanged()||t)&&(e.extensions.sort.sort(),t=!0),e.options.groupBy&&e.extExists("groupRows")?(o.setDisplayRows(e.extensions.groupRows.getRows(this.activeRows,t)),e.options.pagination):e.options.pagination&&e.extExists("page")?("local"==e.extensions.page.getMode()&&(t&&e.extensions.page.reset(),e.extensions.page.setMaxRows(this.activeRows.length)),o.setDisplayRows(e.extensions.page.getRows(this.activeRows))):o.setDisplayRows(o.activeRows.slice(0)),o.element.is(":visible")&&o.renderTable(),e.extExists("columnCalcs")&&e.extensions.columnCalcs.recalc(this.displayRows)},RowManager.prototype.setActiveRows=function(t){this.activeRows=t,this.activeRowsCount=this.activeRows.length},RowManager.prototype.setDisplayRows=function(t){this.displayRows=t,this.displayRowsCount=this.displayRows.length},RowManager.prototype.getRows=function(){return this.rows},RowManager.prototype.renderTable=function(){var t=this;t.table.options.renderStarted(),t.element.scrollTop(0),t.height&&t.table.options.virtualDom&&!t.table.options.pagination?(t.renderMode="virtual",t._virtualRenderFill()):(t.renderMode="classic",t._simpleRender()),t.firstRender&&(t.displayRowsCount?(t.firstRender=!1,t.table.options.fitColumns?t.columnManager.fitToTable():t.columnManager.fitToData()):t.renderEmptyScroll()),t.table.extExists("frozenColumns")&&t.table.extensions.frozenColumns.layout(),t.displayRowsCount||t.table.options.placeholder&&t.getElement().append(t.table.options.placeholder),t.table.options.renderComplete()},RowManager.prototype.getRenderMode=function(){return this.renderMode},RowManager.prototype._simpleRender=function(){var t=this,o=this.tableElement;t._clearVirtualDom(),t.displayRowsCount?t.displayRows.forEach(function(e,i){t.styleRow(e,i),o.append(e.getElement()),e.initialize(!0)}):t.renderEmptyScroll()},RowManager.prototype.renderEmptyScroll=function(){var t=this;t.tableElement.css({"min-width":t.table.columnManager.getWidth(),"min-height":"1px",visibility:"hidden"})},RowManager.prototype._clearVirtualDom=function(){var t=this.tableElement;this.table.options.placeholder&&this.table.options.placeholder.detach(),t.children().detach(),t.css({"padding-top":"","padding-bottom":"","min-width":"","min-height":"",visibility:""}),this.scrollTop=0,this.scrollLeft=0,this.vDomTop=0,this.vDomBottom=0,this.vDomTopPad=0,this.vDomBottomPad=0},RowManager.prototype.styleRow=function(t,o){o%2?t.element.addClass("tabulator-row-even").removeClass("tabulator-row-odd"):t.element.addClass("tabulator-row-odd").removeClass("tabulator-row-even")},RowManager.prototype._virtualRenderFill=function(t,o){var e=this,i=e.tableElement,s=e.element,a=0,n=0,l=0,r=0;if(t=t||0){i.children().detach();var h=(e.displayRowsCount-t)*e.vDomRowHeight;h<e.height&&(t-=Math.ceil((e.height-h)/e.displayRowsCount))<0&&(t=0),t-=a=Math.min(Math.max(Math.floor(e.vDomWindowBuffer/e.vDomRowHeight),e.vDomWindowMinMarginRows),t)}else e._clearVirtualDom();if(e.displayRowsCount&&e.element.is(":visible")){for(e.vDomTop=t,e.vDomBottom=t-1;(n<=e.height+e.vDomWindowBuffer||r<e.vDomWindowMinTotalRows)&&e.vDomBottom<e.displayRowsCount-1;){var p=e.vDomBottom+1,m=e.displayRows[p];e.styleRow(m,p),i.append(m.getElement()),m.initialized?m.heightInitialized||m.normalizeHeight(!0):m.initialize(!0),r<a?l+=m.getHeight():n+=m.getHeight(),e.vDomBottom++,r++}t?(e.vDomTopPad=o?e.vDomRowHeight*this.vDomTop+l:e.scrollTop-l,e.vDomBottomPad=e.vDomBottom==e.displayRowsCount-1?0:Math.max(e.vDomScrollHeight-e.vDomTopPad-n-l,0)):(this.vDomTopPad=0,e.vDomRowHeight=Math.floor((n+l)/r),e.vDomBottomPad=e.vDomRowHeight*(e.displayRowsCount-e.vDomBottom-1),e.vDomScrollHeight=l+n+e.vDomBottomPad-e.height),i[0].style.paddingTop=e.vDomTopPad+"px",i[0].style.paddingBottom=e.vDomBottomPad+"px",o&&(this.scrollTop=e.vDomTopPad+l),this.scrollTop=Math.min(this.scrollTop,this.element[0].scrollHeight-this.height),this.element[0].scrollWidth>this.element[0].offsetWidt&&(this.scrollTop+=this.element[0].offsetHeight-this.element[0].clientHeight),this.vDomScrollPosTop=this.scrollTop,this.vDomScrollPosBottom=this.scrollTop,s.scrollTop(this.scrollTop)}else this.renderEmptyScroll()},RowManager.prototype.scrollVertical=function(t){var o=this.scrollTop-this.vDomScrollPosTop,e=this.scrollTop-this.vDomScrollPosBottom,i=2*this.vDomWindowBuffer;-o>i||e>i?this._virtualRenderFill(Math.floor(this.element[0].scrollTop/this.element[0].scrollHeight*this.displayRowsCount)):t?(o<0&&this._addTopRow(-o),o<0&&this.vDomScrollHeight-this.scrollTop>this.vDomWindowBuffer&&this._removeBottomRow(-e)):(o>=0&&this.scrollTop>this.vDomWindowBuffer&&this._removeTopRow(o),e>=0&&this._addBottomRow(e))},RowManager.prototype._addTopRow=function(t){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,e=this.tableElement;if(this.vDomTop){var i=this.vDomTop-1,s=this.displayRows[i],a=s.getHeight()||this.vDomRowHeight;t>=a&&(this.styleRow(s,i),e.prepend(s.getElement()),s.initialized&&s.heightInitialized||(this.vDomTopNewRows.push(s),s.heightInitialized||s.clearCellHeight()),s.initialize(),this.vDomTopPad-=a,this.vDomTopPad<0&&(this.vDomTopPad=(this.vDomTop-1)*this.vDomRowHeight),e[0].style.paddingTop=this.vDomTopPad+"px",this.vDomScrollPosTop-=a,this.vDomTop--),t=-(this.scrollTop-this.vDomScrollPosTop),o<this.vDomMaxRenderChain&&this.vDomTop&&t>=(this.displayRows[this.vDomTop-1].getHeight()||this.vDomRowHeight)?this._addTopRow(t,o+1):this._quickNormalizeRowHeight(this.vDomTopNewRows)}},RowManager.prototype._removeTopRow=function(t){var o=this.tableElement,e=this.displayRows[this.vDomTop],i=e.getHeight()||this.vDomRowHeight;t>=i&&(e.element.detach(),this.vDomTopPad+=i,o[0].style.paddingTop=this.vDomTopPad+"px",this.vDomScrollPosTop+=this.vDomTop?i:i+this.vDomWindowBuffer,this.vDomTop++,t=this.scrollTop-this.vDomScrollPosTop,this._removeTopRow(t))},RowManager.prototype._addBottomRow=function(t){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,e=this.tableElement;if(this.vDomBottom<this.displayRowsCount-1){var i=this.vDomBottom+1,s=this.displayRows[i],a=s.getHeight()||this.vDomRowHeight;t>=a&&(this.styleRow(s,i),e.append(s.getElement()),s.initialized&&s.heightInitialized||(this.vDomBottomNewRows.push(s),s.heightInitialized||s.clearCellHeight()),s.initialize(),this.vDomBottomPad-=a,(this.vDomBottomPad<0||i==this.displayRowsCount-1)&&(this.vDomBottomPad=0),e[0].style.paddingBottom=this.vDomBottomPad+"px",this.vDomScrollPosBottom+=a,this.vDomBottom++),t=this.scrollTop-this.vDomScrollPosBottom,o<this.vDomMaxRenderChain&&this.vDomBottom<this.displayRowsCount-1&&t>=(this.displayRows[this.vDomBottom+1].getHeight()||this.vDomRowHeight)?this._addBottomRow(t,o+1):this._quickNormalizeRowHeight(this.vDomBottomNewRows)}},RowManager.prototype._removeBottomRow=function(t){var o=this.tableElement,e=this.displayRows[this.vDomBottom],i=e.getHeight()||this.vDomRowHeight;t>=i&&(e.element.detach(),this.vDomBottomPad+=i,this.vDomBottomPad<0&&this.vDomBottomPad,o[0].style.paddingBottom=this.vDomBottomPad+"px",this.vDomScrollPosBottom-=i,this.vDomBottom--,t=-(this.scrollTop-this.vDomScrollPosBottom),this._removeBottomRow(t))},RowManager.prototype._quickNormalizeRowHeight=function(t){t.forEach(function(t){t.calcHeight()}),t.forEach(function(t){t.setCellHeight()}),t.length=0},RowManager.prototype.normalizeHeight=function(){this.displayRows.forEach(function(t){t.normalizeHeight()})},RowManager.prototype.adjustTableSize=function(){var t=this;if(t.table.options.height){var o=t.columnManager.getElement().outerHeight()+(t.table.footerManager?t.table.footerManager.getElement().outerHeight():0);t.element.css({"min-height":"calc(100% - "+o+"px)",height:"calc(100% - "+o+"px)","max-height":"calc(100% - "+o+"px)"}),t.height=t.element.innerHeight(),t.vDomWindowBuffer=t.table.options.virtualDomBuffer||t.height}},RowManager.prototype.reinitialize=function(){this.rows.forEach(function(t){t.reinitialize()})},RowManager.prototype.redraw=function(t){o=0;if("virtual"==this.renderMode&&this.adjustTableSize(),t)this.renderTable();else{if("simple"==self.renderMode)this._simpleRender();else{var o=Math.floor(this.element.scrollTop()/this.element[0].scrollHeight*this.displayRowsCount);this._virtualRenderFill(o)}this.displayRowsCount||this.table.options.placeholder&&this.getElement().append(this.table.options.placeholder)}},RowManager.prototype.resetScroll=function(){this.element.scrollLeft(0),this.element.scrollTop(0),this.element.scroll()};