<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mappers.mssql.hotplaceMapper">

	<select id="selectGuGun" resultType="string" parameterType="string">
		select concat(code, ',"', name, '"') 
		  from (
				select distinct [시군구코드] as code,[시군구명] as name 
				  from [지번주소].[dbo].[PNU10] 
				 where [시도코드] = #{si}
				   and [시군구명] != ''
			   ) t1
	      order by name
	</select>
	
	<select id="selectRegionName" resultType="string" parameterType="Address">
		select concat(code, ',"', name, '"') 
		  from (
				select distinct [읍면동코드] as code, [읍면동명] as name 
				  from [지번주소].[dbo].[PNU10] 
				 where [시도코드] = #{si}
				   and [시군구코드] = #{gugun}
				   and [읍면동명] != ''
			   ) t1
	      order by name
	</select>
	
	<select id="selectAddress" resultType="string" parameterType="Address">
		<if test='type == "N"'>
		select concat('"',[PNU], '","', [시도명], ' ', [시군구명], ' ', [읍면동명], ' ', [리명], <if test="san == '2'">' 산',</if> ' ', [본번숫자], '-', [부번숫자], '",',  [위도], ',', [경도], ',', [극북], ',', [극서]) 
		</if>
   		  from (
   		  		<if test='type == "N"'>
   		  		select [PNU],[필지구분코드],[본번숫자],[부번숫자],[시도명],[시군구명],[읍면동명],[리명],[위도],[경도],[극서],[극북]
   		  		</if>
				  from [지번주소].[dbo].[전국지번통합]  
			     where [시도코드] = #{si}
			       and [시군구코드] = #{gugun}
			       and [읍면동코드] = #{region}
			       <if test='type == "N"'>
			       and [필지구분코드] = #{san}
			       <if test='beonjiF != ""'>
			       and [본번숫자]= #{beonjiF}
			       </if>
			       <if test='beonjiS != ""'>
			       and [부번숫자]= #{beonjiS}
			       </if>
			       </if>
			       and [위도] is not null
			    ) tb1
	</select>
	
	<select id="selectLocationBounds" resultType="string" parameterType="hashmap">
		select concat(극서 , '|', 극남,  '|', 극동, '|', 극북, '|', '[{"type":0, "value":50, "colorV":', case when PNU존재여부='Y' then round(rand(convert(varbinary, newid()))*100, 2) else 0 end, '}]')
          from [좌표계].[dbo].[좌표계]
         where 레벨 = #{level}
           and 극서  between convert(float, #{swx}) and convert(float, #{nex})
           and 극동  between convert(float, #{swx}) and convert(float, #{nex}) 
           and 극남  between convert(float, #{swy}) and convert(float, #{ney})
           and 극북  between convert(float, #{swy}) and convert(float, #{ney})
         order by 극서 asc
	</select>
	
	<select id="selectGongsiBounds" resultType="string" parameterType="hashmap">
	
	</select>
</mapper>
<!-- 
		with tmp as
		(
		   select a.극서, a.극동, a.극남, a.극북, avg(공시지가) [공시지가]
		     from [좌표계].dbo.좌표계13_하위 a with (nolock) 
		    inner join [좌표계].dbo.좌표계13 b with (nolock)
			   on (b.X좌표 between a.좌표계13_X좌표시작 and a.좌표계13_X좌표끝 and b.Y좌표 between a.좌표계13_Y좌표시작 and a.좌표계13_Y좌표끝)
		    inner join 클린징데이터.dbo.공시지가 c with (nolock)
			   on (c.PNU=b.PNU and c.기준년월='201701')
		   where a.레벨=#{level}
		     and a.극서 >= convert(float, #{swx})
			 and a.극동 <![CDATA[<=]]> convert(float, #{nex})
			 and a.극남 >= convert(float, #{swy})
			 and a.극북 <![CDATA[<=]]> convert(float, #{ney}) 
		   group by a.레벨, a.X좌표, a.Y좌표, a.극서, a.극동, a.극남, a.극북
		)
		select  concat(a.극서 , '|', a.극남,  '|', a.극동, '|', a.극북, '|', '[{"type":0, "value":',  공시지가, ',"colorV":', (공시지가-최저가)/편차, '}]')
		from
		(
		   select *, 
		   (select min(공시지가) from tmp) [최저가], 
		   (select max(공시지가) from tmp) [최고가], 
		   (select (max(공시지가)-min(공시지가))/1020 from tmp) [편차] 
		   from tmp a
		) a
		order by a.극서 asc

 -->